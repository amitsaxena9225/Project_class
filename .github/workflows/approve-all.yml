name: Approve All Tickets

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  approve:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, 'APPROVE-ALL')
    steps:
      - name: Approve all tickets in summary
        uses: actions/github-script@v7
        with:
          script: |
            const approver = context.payload.comment.user.login;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const summaryIssue = context.payload.issue;

            // Only allow from summary issue
            if (!summaryIssue.labels.some(l => l.name === "daily-summary")) {
              console.log("Not a daily summary issue. Ignored.");
              return;
            }

            // Read summary issue body
            const body = summaryIssue.body;

            // Extract issue numbers from summary
            const issueNumbers = [...body.matchAll(/#(\d+)/g)].map(m => Number(m[1]));

            if (issueNumbers.length === 0) {
              console.log("No tickets found.");
              return;
            }

            for (const issue_number of issueNumbers) {
              // Prevent double approval
              const comments = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number,
              });

              const alreadyApproved = comments.data.some(c =>
                c.body.includes("Approved by @")
              );

              if (alreadyApproved) continue;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: `âœ… **Approved by @${approver}**\nðŸ“… ${new Date().toISOString().split("T")[0]}`
              });

              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number,
                labels: ["approved"]
              });
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: summaryIssue.number,
              body: `âœ… Approved ${issueNumbers.length} tickets by @${approver}`
            });
