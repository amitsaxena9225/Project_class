name: Approve All Handler (Multi Repo)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  approve:
    runs-on: ubuntu-latest

    steps:
      - name: Process APPROVE-ALL
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_TOKEN }}
          script: |
            const APPROVER = "amitsaxena9225";

            const commentBody = context.payload.comment.body.toUpperCase().trim();
            const commenter   = context.payload.comment.user.login;
            const issue       = context.payload.issue;

            console.log(`Comment: ${commentBody}`);
            console.log(`Commenter: ${commenter}`);

            /************ SECURITY ************/
            if (commentBody !== "APPROVE-ALL") return;
            if (commenter !== APPROVER) return;

            /************ PARSE SUMMARY ************/
            const lines = issue.body.split("\n").filter(l => l.startsWith("• "));
            if (lines.length === 0) {
              console.log("No issue lines found");
              return;
            }

            const items = [];
            for (const line of lines) {
              const match = line.match(/• (.+?)\/(.+?)#(\d+)/);
              if (!match) continue;

              items.push({
                owner: match[1],
                repo: match[2],
                number: parseInt(match[3])
              });
            }

            if (items.length === 0) {
              console.log("No valid issues parsed");
              return;
            }

            /************ APPROVE EACH ISSUE ************/
            for (const i of items) {
              await github.rest.issues.createComment({
                owner: i.owner,
                repo: i.repo,
                issue_number: i.number,
                body: "✅ Approved via **APPROVE-ALL**"
              });

              await github.rest.issues.update({
                owner: i.owner,
                repo: i.repo,
                issue_number: i.number,
                labels: ["approved"]
              });
            }

            /************ CLOSE SUMMARY ************/
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: "✅ **All tickets across all repositories approved.**"
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: "closed"
            });
