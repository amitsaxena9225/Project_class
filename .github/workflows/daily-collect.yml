name: Daily Approval Summary (Multi Repo)

on:
  schedule:
    - cron: "* * * * *"   # 8:30 AM IST
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - name: Create approval summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_TOKEN }}
          script: |
            /************ CONFIG ************/
            const APPROVER = "amitsaxena9225";

            const REPOS = [
              { owner: "amitsaxena9225", repo: "Python_Git_demo" },
              { owner: "amitsaxena9225", repo: "Push_my_code_to_git },
              { owner: "amitsaxena9225", repo: "Amit" }
            ];

            const summaryOwner = context.repo.owner;
            const summaryRepo  = context.repo.repo;

            const today = new Date().toISOString().split("T")[0];
            let allIssues = [];

            /************ COLLECT ISSUES ************/
            for (const r of REPOS) {
              console.log(`Searching ${r.owner}/${r.repo}`);

              const result = await github.rest.search.issuesAndPullRequests({
                q: `is:issue is:open created:${today} repo:${r.owner}/${r.repo}`,
                per_page: 100
              });

              for (const issue of result.data.items) {
                allIssues.push({
                  owner: r.owner,
                  repo: r.repo,
                  number: issue.number,
                  title: issue.title
                });
              }
            }

            if (allIssues.length === 0) {
              console.log("No tickets today");
              return;
            }

            /************ BUILD SUMMARY ************/
            let body =
              `ðŸ“Œ **Daily Approval Summary â€“ ${today}**\n\n` +
              `ðŸ‘¤ **Approver:** @${APPROVER}\n\n` +
              `ðŸ‘‰ Comment **APPROVE-ALL** on THIS issue to approve ALL tickets:\n\n`;

            for (const i of allIssues) {
              body += `â€¢ ${i.owner}/${i.repo}#${i.number} â€“ ${i.title}\n`;
            }

            /************ CREATE SUMMARY ISSUE ************/
            await github.rest.issues.create({
              owner: summaryOwner,
              repo: summaryRepo,
              title: `Daily Approval Summary â€“ ${today}`,
              body,
              labels: ["daily-summary"],
              assignees: [APPROVER]   // ðŸ“§ EMAIL TRIGGER
            });
